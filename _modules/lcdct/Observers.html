<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lcdct.Observers &#8212; LCD for CT Toolbox 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for lcdct.Observers</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">pinv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">laguerre_gaussian_2d</span>

<div class="viewcode-block" id="Observer">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.Observer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Observer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for Model Observers.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_present</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the observer with signal-present and signal-absent images.</span>

<span class="sd">        Args:</span>
<span class="sd">            signal_present: Array of signal-present images (N, Y, X) or (N,).</span>
<span class="sd">            signal_absent: Array of signal-absent images (N, Y, X) or (N,).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># subtract DC component</span>
        <span class="k">if</span> <span class="n">signal_present</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># (N, Y, X)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">signal_present</span> <span class="o">=</span> <span class="n">signal_present</span> <span class="o">-</span> <span class="n">signal_present</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">signal_absent</span> <span class="o">=</span> <span class="n">signal_absent</span> <span class="o">-</span> <span class="n">signal_absent</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal_present</span> <span class="o">=</span> <span class="n">signal_present</span> <span class="o">-</span> <span class="n">signal_present</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal_absent</span> <span class="o">=</span> <span class="n">signal_absent</span> <span class="o">-</span> <span class="n">signal_absent</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span>
<span class="s1">signal present array shape [n, y, x]: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_present</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span>
<span class="s1">signal absent array shape [n, y, x]:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_absent</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="Observer.perform_study">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.Observer.perform_study">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">perform_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_absent_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal_present_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                      <span class="n">signal_absent_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal_present_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs the observer study (train/test) and calculates metrics.</span>

<span class="sd">        Args:</span>
<span class="sd">           signal_absent_train: Training signal-absent images.</span>
<span class="sd">           signal_present_train: Training signal-present images.</span>
<span class="sd">           signal_absent_test: Testing signal-absent images.</span>
<span class="sd">           signal_present_test: Testing signal-present images.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: Dictionary containing metrics &#39;auc&#39; and &#39;snr&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Renamed calculate_auc to perform_study to match MATLAB `measure_LCD` call:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">(</span><span class="n">signal_absent_train</span><span class="p">,</span> <span class="n">signal_present_train</span><span class="p">,</span>
                                      <span class="n">signal_absent_test</span><span class="p">,</span> <span class="n">signal_present_test</span><span class="p">)</span></div>


<div class="viewcode-block" id="Observer.get_splits">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.Observer.get_splits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits data into training and testing sets.</span>

<span class="sd">        Args:</span>
<span class="sd">            pct_split: Percentage of data to use for training.</span>
<span class="sd">            seed: Random seed for splitting.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray, np.ndarray, np.ndarray]: </span>
<span class="sd">                (sa_train, sa_test, sp_train, sp_test).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sp_train</span><span class="p">,</span> <span class="n">sp_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_present</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">pct_split</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">sa_train</span><span class="p">,</span> <span class="n">sa_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_absent</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">pct_split</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sa_train</span><span class="p">,</span> <span class="n">sa_test</span><span class="p">,</span> <span class="n">sp_train</span><span class="p">,</span> <span class="n">sp_test</span></div>


<div class="viewcode-block" id="Observer.run_study">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.Observer.run_study">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_readers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">pct_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs multiple bootstraps/splits of the study.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_readers: Number of random splits (readers).</span>
<span class="sd">            pct_split: Percentage of data used for training.</span>
<span class="sd">            seed: List of seeds for each reader, or None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Results dataframe with cols &#39;auc&#39;, &#39;snr&#39;, &#39;observer&#39;, &#39;reader&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="c1"># Seeds for each reader</span>
        <span class="n">seed_split</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_readers</span><span class="p">)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_readers</span><span class="p">):</span>
            <span class="n">sa_train</span><span class="p">,</span> <span class="n">sa_test</span><span class="p">,</span> <span class="n">sp_train</span><span class="p">,</span> <span class="n">sp_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_splits</span><span class="p">(</span><span class="n">pct_split</span><span class="o">=</span><span class="n">pct_split</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_split</span><span class="p">[</span><span class="n">reader</span><span class="p">])</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_study</span><span class="p">(</span><span class="n">sa_train</span><span class="p">,</span> <span class="n">sp_train</span><span class="p">,</span> <span class="n">sa_test</span><span class="p">,</span> <span class="n">sp_test</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;observer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;reader&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reader</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


<div class="viewcode-block" id="Observer.calculate_metrics">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.Observer.calculate_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sa_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sp_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sa_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sp_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates AUC and SNR metrics. Must be implemented by subclasses.</span>

<span class="sd">        Args:</span>
<span class="sd">            sa_train: Training signal-absent images.</span>
<span class="sd">            sp_train: Training signal-present images.</span>
<span class="sd">            sa_test: Testing signal-absent images.</span>
<span class="sd">            sp_test: Testing signal-present images.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: Dictionary with &#39;auc&#39; and &#39;snr&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</div>



<div class="viewcode-block" id="LG_CHO">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.LG_CHO">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LG_CHO</span><span class="p">(</span><span class="n">Observer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Laguerre-Gaussian Channelized Hotelling Observer.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_present</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">channel_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the LG_CHO observer.</span>

<span class="sd">        Args:</span>
<span class="sd">            signal_present: Training signal-present images.</span>
<span class="sd">            signal_absent: Training signal-absent images.</span>
<span class="sd">            channel_width: Gaussian width parameter for Laguerre-Gaussian channels.</span>
<span class="sd">            n_channels: Number of channels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">signal_present</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_width</span> <span class="o">=</span> <span class="n">channel_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">n_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;LG_CHO_2D&#39;</span>

<div class="viewcode-block" id="LG_CHO.calculate_metrics">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.LG_CHO.calculate_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">trimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates CHO metrics using Laguerre-Gaussian channels.</span>

<span class="sd">        Args:</span>
<span class="sd">           trimg_sa: Training signal-absent images (N, Y, X).</span>
<span class="sd">           trimg_sp: Training signal-present images (N, Y, X).</span>
<span class="sd">           testimg_sa: Testing signal-absent images (N, Y, X).</span>
<span class="sd">           testimg_sp: Testing signal-present images (N, Y, X).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: AUC and SNR.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_sa</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">trimg_sa</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># Assuming images are (N, Y, X)</span>
        
        <span class="c1"># LG channels</span>
        <span class="c1"># Coordinate system centered</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">xxi</span><span class="p">,</span> <span class="n">yyi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="c1"># Note: meshgrid default is &#39;xy&#39; -&gt; xxi corresponds to columns (x), yyi to rows (y)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xxi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yyi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">u</span> <span class="o">=</span> <span class="n">laguerre_gaussian_2d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_width</span><span class="p">)</span>
        <span class="c1"># u shape: (ny, nx, nch)</span>
        
        <span class="n">ch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
        
        <span class="c1"># Training</span>
        <span class="c1"># Flatten images: (N, Y*X)</span>
        <span class="n">tr_sa_flat</span> <span class="o">=</span> <span class="n">trimg_sa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trimg_sa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tr_sp_flat</span> <span class="o">=</span> <span class="n">trimg_sp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trimg_sp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Project onto channels: (N, nch)</span>
        <span class="n">tr_sa_ch</span> <span class="o">=</span> <span class="n">tr_sa_flat</span> <span class="o">@</span> <span class="n">ch</span>
        <span class="n">tr_sp_ch</span> <span class="o">=</span> <span class="n">tr_sp_flat</span> <span class="o">@</span> <span class="n">ch</span>
        
        <span class="c1"># Mean stats</span>
        <span class="n">s_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tr_sp_ch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tr_sa_ch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># (nch,)</span>
        
        <span class="n">k_sa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">tr_sa_ch</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">k_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">tr_sp_ch</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_sa</span> <span class="o">+</span> <span class="n">k_sp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Hotelling template in Channel Space</span>
        <span class="c1"># w_ch = inv(K) * s_ch</span>
        <span class="n">w_ch</span> <span class="o">=</span> <span class="n">s_ch</span> <span class="o">@</span> <span class="n">pinv</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># (nch,)</span>
        
        <span class="c1"># Testing</span>
        <span class="n">te_sa_flat</span> <span class="o">=</span> <span class="n">testimg_sa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testimg_sa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">te_sp_flat</span> <span class="o">=</span> <span class="n">testimg_sp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testimg_sp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">te_sa_ch</span> <span class="o">=</span> <span class="n">te_sa_flat</span> <span class="o">@</span> <span class="n">ch</span>
        <span class="n">te_sp_ch</span> <span class="o">=</span> <span class="n">te_sp_flat</span> <span class="o">@</span> <span class="n">ch</span>
        
        <span class="c1"># Decision variables</span>
        <span class="n">t_sa</span> <span class="o">=</span> <span class="n">te_sa_ch</span> <span class="o">@</span> <span class="n">w_ch</span>
        <span class="n">t_sp</span> <span class="o">=</span> <span class="n">te_sp_ch</span> <span class="o">@</span> <span class="n">w_ch</span>
        
        <span class="c1"># Metrics</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sa</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sp</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># ROC AUC</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sa</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sp</span><span class="p">))])</span>
        <span class="n">y_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">t_sp</span><span class="p">])</span>
        <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span> <span class="s1">&#39;snr&#39;</span><span class="p">:</span> <span class="n">snr</span><span class="p">}</span></div>
</div>



<div class="viewcode-block" id="DOG_CHO">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.DOG_CHO">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DOG_CHO</span><span class="p">(</span><span class="n">Observer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Difference of Gaussian Channelized Hotelling Observer.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_present</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;dense&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the DOG_CHO observer.</span>

<span class="sd">        Args:</span>
<span class="sd">           signal_present: Training signal-present images.</span>
<span class="sd">           signal_absent: Training signal-absent images.</span>
<span class="sd">           type: &#39;dense&#39; or &#39;sparse&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">signal_present</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dog_type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;DOG_CHO_2D&#39;</span>

<div class="viewcode-block" id="DOG_CHO.calculate_metrics">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.DOG_CHO.calculate_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">trimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates CHO metrics using Difference-of-Gaussian channels.</span>

<span class="sd">        Args:</span>
<span class="sd">           trimg_sa: Training signal-absent images (N, Y, X).</span>
<span class="sd">           trimg_sp: Training signal-present images (N, Y, X).</span>
<span class="sd">           testimg_sa: Testing signal-absent images (N, Y, X).</span>
<span class="sd">           testimg_sp: Testing signal-present images (N, Y, X).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: AUC and SNR.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an unknown DOG type is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_sa</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">trimg_sa</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c1"># Build DOG channels</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">nx</span>
        <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">fi</span><span class="p">)</span>
        <span class="n">fxy</span> <span class="o">=</span> <span class="n">fx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fy</span><span class="o">**</span><span class="mi">2</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dog_type</span> <span class="o">==</span> <span class="s1">&#39;dense&#39;</span><span class="p">:</span>
            <span class="n">a0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">nch</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.67</span><span class="p">,</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dog_type</span> <span class="o">==</span> <span class="s1">&#39;sparse&#39;</span><span class="p">:</span>
            <span class="n">a0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">nch</span> <span class="o">=</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown DOG type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dog_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">sdog_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># 1 to nch</span>
            <span class="n">aj</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># aj1 = a0 * (a**i) # Unused in MATLAB code loop? actually used for next band implicitly but equation uses `aj`</span>
            
            <span class="n">exp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fxy</span> <span class="o">/</span> <span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">aj</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Note: MATLAB (Q*aj)^2/2</span>
            <span class="n">exp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fxy</span> <span class="o">/</span> <span class="n">aj</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">sdogfreq</span> <span class="o">=</span> <span class="n">exp1</span> <span class="o">-</span> <span class="n">exp2</span>
            
            <span class="c1"># ifftshift, ifft2, fftshift</span>
            <span class="n">sdog_spatial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">sdogfreq</span><span class="p">)))</span>
            <span class="n">sdog_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdog_spatial</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="c1"># Should be real</span>
            
        <span class="n">ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sdog_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nch</span><span class="p">)</span>
        
        <span class="c1"># Training</span>
        <span class="n">tr_sa_flat</span> <span class="o">=</span> <span class="n">trimg_sa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trimg_sa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tr_sp_flat</span> <span class="o">=</span> <span class="n">trimg_sp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trimg_sp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">tr_sa_ch</span> <span class="o">=</span> <span class="n">tr_sa_flat</span> <span class="o">@</span> <span class="n">ch</span>
        <span class="n">tr_sp_ch</span> <span class="o">=</span> <span class="n">tr_sp_flat</span> <span class="o">@</span> <span class="n">ch</span>
        
        <span class="n">s_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tr_sp_ch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tr_sa_ch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">tr_sa_ch</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">tr_sp_ch</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">w_ch</span> <span class="o">=</span> <span class="n">s_ch</span> <span class="o">@</span> <span class="n">pinv</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        
        <span class="c1"># Testing</span>
        <span class="n">te_sa_flat</span> <span class="o">=</span> <span class="n">testimg_sa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testimg_sa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">te_sp_flat</span> <span class="o">=</span> <span class="n">testimg_sp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testimg_sp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">te_sa_ch</span> <span class="o">=</span> <span class="n">te_sa_flat</span> <span class="o">@</span> <span class="n">ch</span>
        <span class="n">te_sp_ch</span> <span class="o">=</span> <span class="n">te_sp_flat</span> <span class="o">@</span> <span class="n">ch</span>
        
        <span class="n">t_sa</span> <span class="o">=</span> <span class="n">te_sa_ch</span> <span class="o">@</span> <span class="n">w_ch</span>
        <span class="n">t_sp</span> <span class="o">=</span> <span class="n">te_sp_ch</span> <span class="o">@</span> <span class="n">w_ch</span>
        
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sa</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sp</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sa</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sp</span><span class="p">))])</span>
        <span class="n">y_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">t_sp</span><span class="p">])</span>
        <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span> <span class="s1">&#39;snr&#39;</span><span class="p">:</span> <span class="n">snr</span><span class="p">}</span></div>
</div>



<div class="viewcode-block" id="Gabor_CHO">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.Gabor_CHO">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Gabor_CHO</span><span class="p">(</span><span class="n">Observer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gabor Channelized Hotelling Observer.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_present</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nband</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the Gabor_CHO observer.</span>

<span class="sd">        Args:</span>
<span class="sd">            signal_present: Training signal-present images.</span>
<span class="sd">            signal_absent: Training signal-absent images.</span>
<span class="sd">            nband: Number of frequency bands.</span>
<span class="sd">            ntheta: Number of orientations.</span>
<span class="sd">            phase: Phase value or list of phases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">signal_present</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nband</span> <span class="o">=</span> <span class="n">nband</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntheta</span> <span class="o">=</span> <span class="n">ntheta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="k">else</span> <span class="n">phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;GABOR_CHO_2D&#39;</span>

<div class="viewcode-block" id="Gabor_CHO.calculate_metrics">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.Gabor_CHO.calculate_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">trimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates CHO metrics using Gabor channels.</span>

<span class="sd">        Args:</span>
<span class="sd">           trimg_sa: Training signal-absent images (N, Y, X).</span>
<span class="sd">           trimg_sp: Training signal-present images (N, Y, X).</span>
<span class="sd">           testimg_sa: Testing signal-absent images (N, Y, X).</span>
<span class="sd">           testimg_sp: Testing signal-present images (N, Y, X).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: AUC and SNR.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_sa</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">trimg_sa</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">xxi</span><span class="p">,</span> <span class="n">yyi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">xxi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yyi</span><span class="o">**</span><span class="mi">2</span>
        
        <span class="n">theta_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntheta</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mf">8.0</span>
        
        <span class="n">gb_channels</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">):</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">f0</span> <span class="o">+</span> <span class="n">f1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">-</span> <span class="n">f1</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">wf</span><span class="p">)</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">r2</span> <span class="o">/</span> <span class="n">ws</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">theta_val</span> <span class="ow">in</span> <span class="n">theta_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">:</span>
                    <span class="c1"># cos(2*pi*fc*(x*cos + y*sin) + ph)</span>
                    <span class="c1"># MATLAB: xxi*cos + yyi*sin</span>
                    <span class="n">fcos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="p">(</span><span class="n">xxi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_val</span><span class="p">)</span> <span class="o">+</span> <span class="n">yyi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_val</span><span class="p">))</span> <span class="o">+</span> <span class="n">ph</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="n">fcos</span>
                    <span class="n">gb_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            
            <span class="n">f0</span> <span class="o">=</span> <span class="n">f1</span>
            
        <span class="c1"># Stack channels</span>
        <span class="n">ch_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">gb_channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nch</span> <span class="o">=</span> <span class="n">ch_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">ch_stack</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nch</span><span class="p">)</span>
        
        <span class="c1"># Training and Testing same as generic CHO</span>
        <span class="n">tr_sa_flat</span> <span class="o">=</span> <span class="n">trimg_sa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trimg_sa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tr_sp_flat</span> <span class="o">=</span> <span class="n">trimg_sp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trimg_sp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">tr_sa_ch</span> <span class="o">=</span> <span class="n">tr_sa_flat</span> <span class="o">@</span> <span class="n">ch</span>
        <span class="n">tr_sp_ch</span> <span class="o">=</span> <span class="n">tr_sp_flat</span> <span class="o">@</span> <span class="n">ch</span>
        
        <span class="n">s_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tr_sp_ch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tr_sa_ch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">tr_sa_ch</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">tr_sp_ch</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">w_ch</span> <span class="o">=</span> <span class="n">s_ch</span> <span class="o">@</span> <span class="n">pinv</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        
        <span class="n">te_sa_flat</span> <span class="o">=</span> <span class="n">testimg_sa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testimg_sa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">te_sp_flat</span> <span class="o">=</span> <span class="n">testimg_sp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testimg_sp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">te_sa_ch</span> <span class="o">=</span> <span class="n">te_sa_flat</span> <span class="o">@</span> <span class="n">ch</span>
        <span class="n">te_sp_ch</span> <span class="o">=</span> <span class="n">te_sp_flat</span> <span class="o">@</span> <span class="n">ch</span>
        
        <span class="n">t_sa</span> <span class="o">=</span> <span class="n">te_sa_ch</span> <span class="o">@</span> <span class="n">w_ch</span>
        <span class="n">t_sp</span> <span class="o">=</span> <span class="n">te_sp_ch</span> <span class="o">@</span> <span class="n">w_ch</span>
        
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sa</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sp</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sa</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sp</span><span class="p">))])</span>
        <span class="n">y_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">t_sp</span><span class="p">])</span>
        <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span> <span class="s1">&#39;snr&#39;</span><span class="p">:</span> <span class="n">snr</span><span class="p">}</span></div>
</div>



<div class="viewcode-block" id="NPWE">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.NPWE">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NPWE</span><span class="p">(</span><span class="n">Observer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Non-Prewhitening Eye Model Observer.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_present</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">eye</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the NPWE observer.</span>

<span class="sd">        Args:</span>
<span class="sd">            signal_present: Training signal-present images.</span>
<span class="sd">            signal_absent: Training signal-absent images.</span>
<span class="sd">            eye: Boolean, whether to use the eye filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">signal_present</span><span class="p">,</span> <span class="n">signal_absent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eye</span> <span class="o">=</span> <span class="n">eye</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;NPWE_2D&#39;</span>

<div class="viewcode-block" id="NPWE.calculate_metrics">
<a class="viewcode-back" href="../../api.html#lcdct.Observers.NPWE.calculate_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">trimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">testimg_sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates NPWE metrics.</span>

<span class="sd">        Args:</span>
<span class="sd">           trimg_sa: Training signal-absent images (only used for mean signal).</span>
<span class="sd">           trimg_sp: Training signal-present images (only used for mean signal).</span>
<span class="sd">           testimg_sa: Testing signal-absent images.</span>
<span class="sd">           testimg_sp: Testing signal-present images.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: AUC and SNR.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_sa</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">trimg_sa</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c1"># Eye filter</span>
        <span class="c1"># disp_dx = 54/128 # mm</span>
        <span class="c1"># fi = ...</span>
        <span class="c1"># f_ratio = 1/0.1146</span>
        
        <span class="n">disp_dx</span> <span class="o">=</span> <span class="mf">54.0</span> <span class="o">/</span> <span class="mf">128.0</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">disp_dx</span>
        <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">fi</span><span class="p">)</span>
        <span class="n">f_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.1146</span>
        <span class="n">fxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f_ratio</span><span class="o">**</span><span class="mi">2</span>
        
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">0.04</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye</span><span class="p">:</span>
            <span class="n">eyeflt</span> <span class="o">=</span> <span class="p">(</span><span class="n">fxy</span><span class="o">**</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">fxy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eyeflt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span> <span class="c1"># MATLAB: ones(nx,ny)/nx/ny</span>
            <span class="c1"># Wait, MATLAB: `ones(nx, ny)/nx/ny`</span>
            <span class="c1"># This scale factor 1/(nx*ny) might be important for normalization?</span>
            <span class="c1"># Or is it an artifact of FFT implementation?</span>
            <span class="c1"># The MATLAB code comments say &quot;equivalent to no filtering by setting &#39;eyeflt&#39; to ones.&quot;</span>
            <span class="c1"># But line 67 says `ones(nx, ny)/nx/ny`.</span>
            <span class="c1"># I will follow MATLAB logic strictly.</span>
            
        <span class="c1"># Training (mean signal)</span>
        <span class="c1"># s_eye = fftshift(fft2(s)) .* eyeflt</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trimg_sp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trimg_sa</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">s_eye</span> <span class="o">=</span> <span class="n">s_fft</span> <span class="o">*</span> <span class="n">eyeflt</span>
        
        <span class="c1"># Testing</span>
        <span class="c1"># te_sa_eye = fftshift(fft2(test_img)) .* eyeflt</span>
        <span class="c1"># t_sa = real(s_eye(:)&#39; * te_sa_eye(:))</span>
        <span class="c1"># Internal product in freq domain involves conj?</span>
        <span class="c1"># MATLAB `s_eye(:)&#39; * te_sa_eye` is dot product.</span>
        <span class="c1"># `s_eye` is complex. `s_eye(:)&#39;` is conjugate transpose (Hermitian).</span>
        <span class="c1"># So it is sum(conj(s_eye) * te_sa_eye).</span>
        <span class="c1"># This is equivalent to cross-correlation at 0 lag in freq domain if handled correctly.</span>
        <span class="c1"># Or Just inner product.</span>
        
        <span class="c1"># Let&#39;s Vectorize testing</span>
        <span class="c1"># Test images: (N, Y, X)</span>
        <span class="c1"># FFT all</span>
        
        <span class="c1"># We can optimize: s_eye is constant.</span>
        <span class="c1"># t = Real( Sum( Conj(S_eye) * Test_Eye ) )</span>
        
        <span class="n">flattened_s_eye</span> <span class="o">=</span> <span class="n">s_eye</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># 1D array</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span><span class="n">images</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="c1"># images: (N, Y, X)</span>
            <span class="n">n_imgs</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="n">eyeflt</span>
                <span class="c1"># dot product: s_eye&#39; * tmp</span>
                <span class="c1"># np.vdot(a, b) does conjugate(a) * b?</span>
                <span class="c1"># MATLAB: s_eye(:)&#39; * te_sa_eye</span>
                <span class="c1"># This is conjugate transpose of s_eye</span>
                <span class="c1"># np.vdot(a, b) is sum(conj(a)*b). So correct.</span>
                <span class="c1"># using vdot on flattened arrays</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">flattened_s_eye</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">real</span>
            <span class="k">return</span> <span class="n">scores</span>

        <span class="n">t_sa</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">testimg_sa</span><span class="p">)</span>
        <span class="n">t_sp</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">testimg_sp</span><span class="p">)</span>
        
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_sa</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sp</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sa</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_sp</span><span class="p">))])</span>
        <span class="n">y_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">t_sa</span><span class="p">,</span> <span class="n">t_sp</span><span class="p">])</span>
        <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span> <span class="s1">&#39;snr&#39;</span><span class="p">:</span> <span class="n">snr</span><span class="p">}</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">LCD for CT Toolbox</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#module-lcd_gui">GUI Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#module-lcdct">MATLAB API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Brandon Nelson, Rongping Zeng, Prabhat Kc.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>