Usage
=====

Intended Purpose
----------------

The LCD-CT software tool is intended for quantitatively evaluating the Low contrast detectability (LCD) performance of advanced nonlinear CT image reconstruction and denoising products using the MITA-LCD phantom images.

Intended users are CT device developers and  image denoising and processing software developers. Advanced nonlinear CT image reconstruction and denoising methods (products code JAK_, QIH_, LLZ_ among others) includes statistically iterative, model-based iterative and deep learning-based image reconstruction and denoising methods.

.. _JAK: https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfPCD/classification.cfm?id=5631

.. _QIH: https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfPCD/classification.cfm?id=5704

.. _LLZ: https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfPCD/classification.cfm?id=5654

The LCD performance obtained using the LCD-CT tools can help the assessment of image quality improvement and quantitative dose reduction potential of advanced nonlinear CT image reconstruction and denoising methods with respect to a reference reconstruction option such as the FBP method. 


How to Use the LCD-CT Toolkit
-----------------------------

After installing review the `LCD-CT Toolkit Documentation <https://lcd-ct.readthedocs.io/en/latest/>`_ and explore the demos to learn how to use the tool to assess low contrast detectability:

**Python Demos**

- `demo_01_singlerecon_LCD.py <https://github.com/DIDSR/LCD_CT/blob/main/demo_01_singlerecon_LCD.py>`_
- `demo_02_tworecon_LCD.py <https://github.com/DIDSR/LCD_CT/blob/main/demo_02_tworecon_LCD.py>`_
- `demo_03_tworecon_dosecurve_LCD.py <https://github.com/DIDSR/LCD_CT/blob/main/demo_03_tworecon_dosecurve_LCD.py>`_

**MATLAB/Octave Demos**

- `demo_01_singlerecon_LCD.m <https://github.com/DIDSR/LCD_CT/blob/main/demo_01_singlerecon_LCD.m>`_ *Expected run time (Octave): 6 s*
- `demo_02_tworecon_LCD.m <https://github.com/DIDSR/LCD_CT/blob/main/demo_02_tworecon_LCD.m>`_ *Expected run time (Octave): 14 s*
- `demo_03_tworecon_dosecurve_LCD.m <https://github.com/DIDSR/LCD_CT/blob/main/demo_03_tworecon_dosecurve_LCD.m>`_ *Expected run time (Octave): 19 s*

Additional demos of tool usage can be found in `additional_demos <https://github.com/DIDSR/LCD_CT/tree/main/additional_demos>`_.

Working with Custom Phantoms
----------------------------

The toolkit supports analyzing images from custom phantoms (non-MITA standard) by defining the insert locations, sizes, and optionally HU values. This can be done programmatically or interactively.

**1. Programmatic Configuration**

Instead of passing a ground truth image/filename, you can pass a configuration object to ``measure_LCD``.

*Python:* Pass a list of dictionaries.

.. code-block:: python

    config = [
        {'x': 30, 'y': 50, 'r': 10, 'HU': 110},
        {'x': 70, 'y': 50, 'r': 10, 'HU': 120}
    ]
    results = measure_LCD(signal_present, signal_absent, config, observers)

*MATLAB/Octave:* Pass a struct.

.. code-block:: octave

    config.x = [30, 70];
    config.y = [50, 50];
    config.r = 10; % Radius (scalar or vector)
    config.HU = [110, 120];
    results = measure_LCD(signal_present, signal_absent, config, observers);

**2. Interactive Selection**

You can interactively select insert centers from an image using the provided helper tools.

*Python:*

.. code-block:: python

    from lcdct.select_inserts_interactive import select_inserts_interactive

    # Select 2 inserts, saves to file
    coords = select_inserts_interactive(image, n_inserts=2, output_filename='coords.json')

*MATLAB/Octave:*

.. code-block:: octave

    % Select 2 inserts, saves to file
    coords = select_inserts_interactive(image, 2, 'coords.mat');

**Results Example**

The following plot shows results from a custom phantom analysis (generated by ``additional_demos/demo_custom_phantom.py``):

.. image:: custom_phantom_results.png
        :width: 800
        :align: center

See ``additional_demos/demo_custom_phantom.py`` and ``additional_demos/demo_custom_phantom.m`` for complete examples.

**Accessing the Large Dataset**

By default the supplied demos and test scripts will use the `small dataset <https://github.com/DIDSR/LCD_CT/tree/main/data/small_dataset>`_ (155 images, 16 MB) included in the repository. The boolean `use_large_dataset` is set to False by default https://github.com/DIDSR/LCD_CT/blob/aa9a907376a413d2b87c434590c033d812e2ac75/test.m#L6

Changing the variable to true followed by rerunning any of the scripts will download from `Zenodo <https://zenodo.org/record/7996580>`_ the large dataset (1.3 GB) and use it in subsequent analyses

The following AUC-vs-dose curves were generated by demo_03_tworecon_dosecurve_LCD.m using the large data set available at `Zenodo <https://zenodo.org/record/7996580>`_ and the LG channelized Hoteling model observer.

.. code-block:: python

        use_large_dataset = True
        # Run the script directly
        python demo_03_tworecon_dosecurve_LCD.py

.. code-block:: octave

        >> use_large_dataset = true
        >> demo_03_tworecon_dosecurve_LCD

.. image:: lcd_v_dose.png
        :width: 800
        :align: center

Michigan Image Reconstruction Toolkit
-------------------------------------

The LCD Phantom Creation code uses functions from `Michigan Image Reconstruction Toolkit (MIRT) <https://github.com/JeffFessler/mirt>`_. It should be automatically downloaded and installed when 'demo_test_phantomcreation.m' is run. If the automatic download does not work (this can happen when the matlab/octave unzip() function does not successfully extract all the files), this can be done manually:

1) download MIRT from https://github.com/JeffFessler/mirt; 
2) Unzip MIRT to a local directory; 
3) In Matlab, Run the file "setup.m" in the MIRT local directory to add all the MIRT subdirectories to the MATLAB workspace;  

To test whether the setup is successful, run **demo_test_phantomcreation.m**.

Graphical User Interface (GUI)
------------------------------

A user-friendly GUI is available for viewing images, defining ROIs, and running LCD analysis.

**Launching the GUI:**

.. code-block:: shell

    python lcd_gui.py

**Features:**
- **Interactive Viewing:** Scroll through image stacks and adjust window/level settings (presets available).
- **ROI Selection:** Interactive clicking to define ROI centers for signal present/absent data.
- **Analysis:** Automatically calculates ROI statistics, performs model observer analysis (LG-CHO), and plots ROC curves.
- **Results:** Displays AUC, d', and allows downloading results as CSV.

Demos
-----
These demos are intended to be run linearly and demonstrate the use of the LCD-CT tool and how it can be used in more sophisticated loops to understand LCD relationships with different imaging conditions, lesions, and model observer types.

.. .. autoscript:: demo_01_singlerecon_LCD.m

.. .. autoscript:: demo_02_tworecon_LCD.m

.. .. autoscript:: demo_03_tworecon_dosecurve_LCD.m

.. image:: https://sandbox.zenodo.org/badge/DOI/10.5072/zenodo.1150650.svg
   :target: https://sandbox.zenodo.org/record/1150650
